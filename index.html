<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe | Metallic OS</title>
    
    <!-- Preconnect for speed -->
    <link rel="preconnect" href="https://is1-ssl.mzstatic.com">
    <link rel="preconnect" href="https://upload.wikimedia.org">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FONTS: Figtree for Spotify-like typography -->
    <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        /* --- CORE VARIABLES (METALLIC OS) --- */
        :root {
            --bg-core: transparent; 
            --bg-glass: rgba(0, 0, 0, 0.4);
            --bg-glass-heavy: rgba(0, 0, 0, 0.8);
            --text-main: #ffffff; 
            --text-sub: #a1a1aa; 
            --accent-color: #1ed760; /* Spotify Green */
        }

        body {
            background-color: #000;
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            font-weight: 300;
            overflow: hidden;
            user-select: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0; padding: 0;
            font-size: 14px;
        }

        /* --- TYPOGRAPHY --- */
        h1, h2, h3, .brand-font, #page-title, .sidebar-header, .section-title { 
            font-family: 'Figtree', sans-serif; 
        }

        #page-title {
            font-weight: 800;
            letter-spacing: -0.03em; 
            font-size: 3.5rem; 
            color: #fff;
            line-height: 1.1;
            transition: all 0.3s ease;
        }
        
        .sidebar-header { font-weight: 700; letter-spacing: -0.01em; }

        .section-header {
            display: flex; align-items: center; gap: 12px; margin-top: 2.5rem; margin-bottom: 1rem; padding-left: 4px;
        }

        .section-title {
            font-size: 1.5rem; font-weight: 700; color: white; letter-spacing: -0.02em; margin: 0 !important; 
        }
        
        /* See All Button */
        .see-all-btn {
            opacity: 0.5;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            width: 32px; height: 32px; border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05);
            color: #a1a1aa;
        }
        .section-header:hover .see-all-btn { opacity: 1; border-color: rgba(255,255,255,0.3); }
        .see-all-btn:hover { background: white !important; color: black !important; transform: scale(1.1); box-shadow: 0 0 15px rgba(255,255,255,0.2); }

        /* --- ANIMATIONS --- */
        .nav-btn, .song-card, .curated-card, button, .playlist-option, .mood-card, .profile-card, .chip, .modal-box, #toast, .scroll-btn, .artist-card { 
            transition-property: transform, background-color, border-color, color, box-shadow, opacity, width, filter;
            transition-duration: 0.2s; 
            transition-timing-function: cubic-bezier(0.25, 0.46, 0.45, 0.94); 
        }
        
        input { transition: border-color 0.2s, background-color 0.2s; }
        .clicked-effect { transform: scale(0.94) !important; filter: brightness(1.2); transition-duration: 0.05s !important; }
        .img-fade { opacity: 0; transition: opacity 0.5s ease-out; }
        .img-fade.loaded { opacity: 1; }

        .nav-btn.active-nav { 
            background: rgba(255,255,255,0.1) !important; 
            color: white !important; 
            border-left: 4px solid var(--accent-color); 
            padding-left: 12px !important;
            font-weight: 700; 
        }
        
        .curated-card { border: 1px solid rgba(255,255,255,0.05); }
        .curated-card:hover { transform: translateY(-2px); border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .curated-card.active-curated { border-color: rgba(255,255,255,0.4); background: rgba(255,255,255,0.15); }
        .curated-card.active-curated .curated-icon-box { transform: scale(1.1); box-shadow: 0 0 15px currentColor; }

        /* --- ARTIST CARD (CIRCULAR) --- */
        .artist-card {
            display: flex; flex-direction: column; align-items: center; gap: 12px; cursor: pointer; width: 140px; flex-shrink: 0; 
            transition: all 0.3s ease; position: relative;
        }
        .artist-img-container {
            width: 130px; height: 130px; 
            border-radius: 50%; 
            overflow: hidden; 
            position: relative; 
            border: 1px solid rgba(255,255,255,0.1); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
            background: #111; 
            transition: all 0.2s ease;
        }
        .artist-img { 
            width: 100%; height: 100%; 
            object-fit: cover; 
            object-position: center top; 
        }
        .artist-card:hover { transform: translateY(-5px); }
        .artist-card:hover .artist-img-container { border-color: rgba(255,255,255,0.6); transform: scale(1.03); box-shadow: 0 0 25px rgba(255,255,255,0.15); }
        .artist-name {
            font-size: 0.95rem; font-weight: 600; color: #ccc; text-align: center; letter-spacing: -0.01em; transition: color 0.2s; font-family: 'Figtree', sans-serif;
        }
        .artist-card:hover .artist-name { color: white; }


        .screen-container { position: fixed; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; background: #000000; opacity: 0; transition: opacity 0.1s ease-in-out; z-index: 10000; }
        .screen-container.active-flex { display: flex; }
        .screen-container.visible { opacity: 1; }
        @keyframes revealUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-15px); } to { opacity: 1; transform: translateY(0); } }

        #welcome-screen { z-index: 30000; }
        .brand-logo-container { width: 80px; height: 80px; border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 2rem; opacity: 0; animation: fadeInDown 0.4s cubic-bezier(0.2, 1, 0.3, 1) forwards 0.1s; background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%); }
        .premium-title { font-family: 'Figtree', sans-serif; font-size: 5rem; font-weight: 800; line-height: 1; color: white; letter-spacing: -0.04em; opacity: 0; animation: revealUp 0.5s cubic-bezier(0.2, 1, 0.3, 1) forwards 0.2s; }
        .premium-tagline { font-family: 'Inter', sans-serif; font-size: 0.85rem; letter-spacing: 0.3em; text-transform: uppercase; color: #888; margin-top: 1.5rem; opacity: 0; animation: revealUp 0.4s cubic-bezier(0.2, 1, 0.3, 1) forwards 0.3s; }
        .enter-btn { margin-top: 4rem; padding: 14px 40px; background: transparent; border: 1px solid rgba(255,255,255,0.15); color: white; font-family: 'Figtree', sans-serif; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.15em; border-radius: 100px; cursor: pointer; transition: all 0.2s ease; opacity: 0; animation: revealUp 0.4s ease forwards 0.4s; font-weight: 700; }
        .enter-btn:hover { background: white; color: black; box-shadow: 0 0 40px rgba(255,255,255,0.2); border-color: white; transform: translateY(-2px); }

        #profile-screen { z-index: 25000; background: #050505; }
        .profile-card { display: flex; flex-direction: column; align-items: center; gap: 16px; cursor: pointer; transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); opacity: 0; transform: translateY(20px); }
        .screen-container.visible .profile-card:nth-child(1) { animation: revealUp 0.3s forwards 0.1s; }
        .screen-container.visible .profile-card:nth-child(2) { animation: revealUp 0.3s forwards 0.15s; }
        .screen-container.visible .profile-card:nth-child(3) { animation: revealUp 0.3s forwards 0.2s; }
        .screen-container.visible #profile-title { animation: revealUp 0.3s forwards 0.05s; }
        .screen-container.visible .manage-btn { animation: revealUp 0.3s forwards 0.2s; }
        .profile-card:hover { transform: scale(1.05) translateY(-5px); }
        .profile-img { width: 120px; height: 120px; border-radius: 50%; background-size: cover; border: 2px solid #333; transition: all 0.2s ease; }
        .profile-card:hover .profile-img { border-color: white; box-shadow: 0 0 30px rgba(255,255,255,0.15); }
        
        #mood-screen { z-index: 24000; background: rgba(10,10,10,0.95); backdrop-filter: blur(40px); }
        .mood-grid { display: flex; gap: 24px; flex-wrap: wrap; justify-content: center; }
        .mood-card { width: 130px; height: 150px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; cursor: pointer; transition: all 0.2s; opacity: 0; transform: translateY(20px); }
        .screen-container.visible .mood-card { animation: revealUp 0.3s forwards; }
        .mood-card:hover { background: rgba(255,255,255,0.1); transform: translateY(-5px); border-color: white; }

        .modal-overlay { position: fixed; inset: 0; z-index: 15000; background: rgba(0,0,0,0.8); backdrop-filter: blur(15px); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.2s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-box { background: rgba(20,20,20,0.95); backdrop-filter: blur(30px); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 32px; width: 100%; max-width: 450px; text-align: center; transform: scale(0.95); transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 20px 60px rgba(0,0,0,0.9); }
        .modal-overlay.active .modal-box { transform: scale(1); }

        #ai-playlist-modal .modal-box {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            max-width: 500px;
            text-align: left;
            position: relative;
            overflow: hidden;
        }
        #ai-playlist-modal .modal-box::before {
            content: ''; position: absolute; top: -50px; right: -50px; width: 150px; height: 150px;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.4) 0%, transparent 70%);
            filter: blur(20px); pointer-events: none;
        }

        .playlist-option { display: flex; align-items: center; justify-content: space-between; padding: 14px; border-bottom: 1px solid rgba(255,255,255,0.08); cursor: pointer; transition: background 0.2s; border-radius: 8px; }
        .playlist-option:hover { background: rgba(255,255,255,0.05); }
        .playlist-option:last-child { border-bottom: none; }

        .vibe-input { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 12px 16px; border-radius: 12px; margin-top: 12px; outline: none; font-size: 1rem; transition: border-color 0.2s; font-weight: 400; }
        .vibe-input:focus { border-color: rgba(139, 92, 246, 0.5); background: rgba(255,255,255,0.08); }
        .vibe-input::placeholder { font-weight: 300; color: #666; }

        .metallic-bg { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            z-index: -2;
            background: #000;
            background-image: radial-gradient(circle at 50% -20%, #333333 0%, transparent 40%),
                            radial-gradient(circle at 100% 50%, #1a1a1a 0%, transparent 30%),
                            radial-gradient(circle at 0% 50%, #222 0%, transparent 40%);
            background-size: 200% 200%; animation: metalFlow 20s ease-in-out infinite alternate; 
        }

        #art-bg {
            position: fixed; inset: 0; z-index: -1;
            background-size: cover; background-position: center;
            filter: blur(70px) brightness(0.6) saturate(1.3);
            opacity: 0; transition: opacity 0.6s ease, background-image 0.6s ease;
            transform: scale(1.1);
        }
        #art-bg.active { opacity: 1; }
        @keyframes metalFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 20%; } 100% { background-position: 0% 50%; } }

        /* --- SCROLLBARS --- */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 10px; transition: background 0.2s; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.35); box-shadow: 0 0 10px rgba(255,255,255,0.1); }
        
        /* HIDE SCROLLBAR FOR HORIZONTAL ROWS (CRITICAL FOR NETFLIX FEEL) */
        .horizontal-scroll {
            display: flex;
            overflow-x: auto;
            gap: 24px;
            padding-bottom: 16px;
            scroll-behavior: smooth;
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .horizontal-scroll::-webkit-scrollbar { display: none; }
        
        .custom-scroll, #queue-list, #queue-content {
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.15) transparent;
        }

        /* --- SONG CARD STYLES --- */
        .song-card {
            background: #1a1a1a; border-radius: 12px; position: relative; overflow: hidden; transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); cursor: pointer; border: 1px solid rgba(255,255,255,0.05); aspect-ratio: 3/4; 
            flex-shrink: 0; width: 200px;
        }
        .song-card:hover { transform: translateY(-6px) scale(1.02); border-color: rgba(255,255,255,0.3); z-index: 10; box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        .song-card.animate-in { animation: revealUp 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        /* Grid Mode for Artist Expansion */
        .grid .song-card { width: 100%; aspect-ratio: 3/4; }

        .card-bg-img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; opacity: 0.9; }
        .song-card:hover .card-bg-img { transform: scale(1.1); opacity: 1; }

        .card-gradient-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.6) 30%, transparent 70%); }
        .card-content { position: absolute; bottom: 0; left: 0; width: 100%; padding: 16px; transform: translateY(0); transition: transform 0.2s; }
        .card-title { font-weight: 600; color: white; font-size: 1rem; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 0 2px 10px rgba(0,0,0,0.8); letter-spacing: -0.02em; }
        .card-artist { font-size: 0.85rem; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 300; }

        .play-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -40%) scale(0.8); width: 56px; height: 56px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0; transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 30; pointer-events: none; }
        .song-card:hover .play-overlay { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        
        /* --- UPDATED BUTTON STYLES FOR GREEN HEART --- */
        .card-icon-btn { 
            position: absolute; width: 36px; height: 36px; 
            background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); 
            border: 1px solid rgba(255,255,255,0.1); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            opacity: 0; transition: all 0.2s ease; z-index: 40; 
            top: 12px; /* Ensure they are at top */
        }
        .pos-tr { right: 12px; transform: translateY(-10px); } 
        .pos-tl { left: 12px; transform: translateY(-10px); } 
        
        .song-card:hover .pos-tr, .song-card:hover .pos-tl { opacity: 1; transform: translateY(0); }
        
        .card-icon-btn:hover { background: rgba(255,255,255,0.95); color: black; transform: scale(1.1); }
        .card-icon-btn:hover i { color: black; }
        
        /* GREEN FILLED HEART */
        .pos-tl.liked { 
            background: rgba(30, 215, 96, 0.15); /* Minimal green tint background */
            border-color: var(--accent-color);
            opacity: 1 !important; /* Keep visible */
        }
        .pos-tl.liked i { 
            fill: var(--accent-color); /* Fill with Spotify Green */
            color: var(--accent-color);
            stroke: var(--accent-color); 
        }

        .row-container { position: relative; }

        .scroll-btn {
            position: absolute; top: 55%; transform: translateY(-50%); width: 48px; height: 48px; background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 50; cursor: pointer; opacity: 0; transition: all 0.2s ease; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .group:hover .scroll-btn { opacity: 1; }
        .scroll-btn:hover { background: white; color: black; transform: translateY(-50%) scale(1.1); }
        .scroll-btn.left { left: -20px; }
        .scroll-btn.right { right: -10px; }
        .scroll-btn.hidden-arrow { opacity: 0; pointer-events: none; }

        #track-menu { position: fixed; z-index: 500; background: rgba(20,20,20,0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; padding: 6px; min-width: 180px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); display: none; opacity: 0; transform: scale(0.95); transition: all 0.1s; }
        #track-menu.active { display: block; opacity: 1; transform: scale(1); }
        .menu-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; color: #ddd; font-size: 0.85rem; border-radius: 8px; cursor: pointer; transition: background 0.05s; font-weight: 400; }
        .menu-item:hover { background: rgba(255,255,255,0.1); color: white; }

        #search-suggestions { position: absolute; top: 100%; left: 0; width: 100%; margin-top: 8px; background: rgba(15,15,15,0.98); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); z-index: 100; max-height: 0; opacity: 0; overflow: hidden; transition: all 0.2s; }
        #search-suggestions.active { max-height: 300px; opacity: 1; overflow-y: auto; }
        .suggestion-item { display: flex; align-items: center; gap: 12px; padding: 10px 14px; cursor: pointer; transition: background 0.05s; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .suggestion-item:hover { background: rgba(255,255,255,0.1); }

        .playbar { background: var(--bg-glass-heavy); backdrop-filter: blur(30px); border-top: 1px solid rgba(255,255,255,0.08); height: 90px; padding: 0 24px; position: relative; z-index: 50; flex-shrink: 0; transition: background 0.2s; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; outline: none; padding: 0; margin: 0; cursor: pointer; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: #fff; margin-top: -4px; opacity: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.5); transition: opacity 0.1s; }
        .slider-group:hover input[type=range]::-webkit-slider-thumb { opacity: 1; transform: scale(1.2); }

        .right-panel { width: 0; opacity: 0; background: var(--bg-glass-heavy); backdrop-filter: blur(30px); border-left: 1px solid rgba(255,255,255,0.08); transition: width 0.2s cubic-bezier(0.2, 0, 0, 1), opacity 0.1s; overflow: hidden; display: flex; flex-direction: column; height: 100%; }
        .right-panel.open { width: 360px; opacity: 1; padding: 24px; }

        .preview-container { width: 100%; position: relative; border-radius: 12px; overflow: hidden; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); aspect-ratio: 1/1; margin-bottom: 1.5rem; flex-shrink: 0; }
        .preview-container.video-mode { aspect-ratio: 16/9 !important; }
        .preview-container.shrunk { height: 180px; aspect-ratio: unset !important; margin-bottom: 1rem; }
        #side-art, #video-player-container { width: 100%; height: 100%; object-fit: cover; }
        #video-player-container iframe { width: 100%; height: 100%; }

        #queue-content, #lyrics-container { flex: 1; overflow-y: auto; min-height: 0; opacity: 0; transition: opacity 0.1s; display: none; }
        #queue-content.active, #lyrics-container.active { display: block; opacity: 1; }

        #toast { position: fixed; top: 24px; left: 50%; transform: translateX(-50%) translateY(-100px); background: rgba(20,20,20,0.95); backdrop-filter: blur(15px); color: #fff; border: 1px solid rgba(255,255,255,0.1); padding: 12px 24px; border-radius: 30px; font-weight: 500; font-size: 0.9rem; z-index: 20000; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 10px; }
        #toast.active { transform: translateX(-50%) translateY(0); }

        .rhythm-btn { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #2563eb, #60a5fa); display: flex; align-items: center; justify-content: center; box-shadow: 0 0 15px rgba(37, 99, 235, 0.4); transition: transform 0.2s, box-shadow 0.2s; animation: pulse-soft 3s infinite; margin-left: 16px; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); }
        .rhythm-btn:hover { transform: scale(1.1); box-shadow: 0 0 25px rgba(37, 99, 235, 0.6); }
        @keyframes pulse-soft { 0%, 100% { box-shadow: 0 0 15px rgba(37, 99, 235, 0.4); } 50% { box-shadow: 0 0 25px rgba(37, 99, 235, 0.2); } }

        #listening-overlay { position: fixed; inset: 0; z-index: 12000; background: rgba(5, 5, 5, 0.8); backdrop-filter: blur(40px); display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.2s; }
        #listening-overlay.active { opacity: 1; visibility: visible; }

        .mode-switch { display: flex; background: rgba(255,255,255,0.05); border-radius: 20px; padding: 4px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .mode-option { flex: 1; text-align: center; padding: 8px 0; font-size: 0.85rem; font-weight: 600; color: #888; border-radius: 16px; cursor: pointer; transition: all 0.1s; }
        .mode-option.active { background: rgba(255,255,255,0.9); color: black; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }

        .panel-tab { padding-bottom: 8px; color: #666; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; transition: all 0.1s; }
        .panel-tab.active { color: white; border-bottom-color: white; }

        .ai-gradient-text { background: linear-gradient(90deg, #fff, #a5f3fc, #e879f9); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-size: 200% auto; animation: shine 3s linear infinite; font-weight: 600; }
        @keyframes shine { to { background-position: 200% center; } }

        .ai-response-box { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; margin-top: 16px; font-size: 0.9rem; line-height: 1.6; color: #d1d5db; }

        .browse-card { aspect-ratio: 1/1; border-radius: 10px; padding: 16px; position: relative; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
        .browse-card:hover { transform: scale(1.02); }
        .browse-card img { position: absolute; bottom: 0; right: 0; width: 70px; height: 70px; transform: rotate(25deg) translate(18%, -2%); box-shadow: -2px 2px 10px rgba(0,0,0,0.3); }
        .browse-title { font-weight: 700; font-size: 1.2rem; color: white; position: relative; z-index: 10; letter-spacing: -0.02em; }

        .chip { font-size: 0.8rem; padding: 6px 12px; background: rgba(255,255,255,0.1); border-radius: 20px; cursor: pointer; border: 1px solid transparent; transition: all 0.1s; font-weight: 400; }
        .chip:hover { background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); }

    </style>
</head>
<body class="flex flex-col h-screen text-sm">

    <!-- Background Layers -->
    <div id="art-bg"></div>
    <div class="metallic-bg"></div>

    <!-- 1. Premium Welcome Screen -->
    <div id="welcome-screen" class="screen-container visible active-flex">
        <div class="brand-logo-container"><i data-lucide="audio-waveform" class="w-10 h-10 text-white"></i></div>
        <div class="premium-title">Vibe</div>
        <div class="premium-tagline">Feel the Music. Live the Vibe.</div>
        <button class="enter-btn" onclick="transitionToProfile()">Experience Now</button>
    </div>

    <!-- 2. Profile Selection -->
    <div id="profile-screen" class="screen-container">
        <h1 class="text-4xl font-bold text-white brand-font mb-16 tracking-wide" id="profile-title" style="font-size: 2.5rem;">Who is listening?</h1>
        <div class="flex gap-12">
            <div class="profile-card" onclick="transitionToMood('User')"><div class="profile-img" style="background-image: url('https://api.dicebear.com/7.x/avataaars/svg?seed=Felix');"></div><span class="profile-name">You</span></div>
            <div class="profile-card" onclick="transitionToMood('Guest')"><div class="profile-img" style="background-image: url('https://api.dicebear.com/7.x/avataaars/svg?seed=Guest');"></div><span class="profile-name">Guest</span></div>
            <div class="profile-card" onclick="transitionToMood('Kids')"><div class="profile-img" style="background-image: url('https://api.dicebear.com/7.x/avataaars/svg?seed=Kids');"></div><span class="profile-name">Kids</span></div>
        </div>
        <div class="mt-16 border border-[#333] px-8 py-3 rounded-full text-gray-500 text-xs uppercase tracking-widest hover:bg-[#111] hover:text-white cursor-pointer transition-all manage-btn">Manage Profiles</div>
    </div>

    <!-- 3. Mood Selection -->
    <div id="mood-screen" class="screen-container">
        <div class="text-center max-w-2xl">
            <h2 class="text-4xl font-bold text-white brand-font mb-2" style="font-size: 3rem;">Hi, What's your mood?</h2>
            <p class="text-gray-400 mb-10 text-lg">We'll tailor the acoustic environment for you.</p>
            <div class="mood-grid">
                <div class="mood-card" onclick="selectMood('chill')"><i data-lucide="coffee" class="mood-icon w-8 h-8 text-white"></i><span class="font-medium text-gray-300">Chill</span></div>
                <div class="mood-card" onclick="selectMood('energetic')"><i data-lucide="zap" class="mood-icon w-8 h-8 text-white"></i><span class="font-medium text-gray-300">Energetic</span></div>
                <div class="mood-card" onclick="selectMood('focus')"><i data-lucide="brain-circuit" class="mood-icon w-8 h-8 text-white"></i><span class="font-medium text-gray-300">Focus</span></div>
                <div class="mood-card" onclick="selectMood('party')"><i data-lucide="speaker" class="mood-icon w-8 h-8 text-white"></i><span class="font-medium text-gray-300">Party</span></div>
            </div>
            <div class="mt-10"><button onclick="transitionToApp('top hits 2024')" class="text-gray-500 hover:text-white text-sm uppercase tracking-wider transition-colors">Skip for now</button></div>
        </div>
    </div>

    <!-- Overlays -->
    <div id="listening-overlay">
        <div class="listening-pulse"><i data-lucide="mic" class="w-12 h-12 text-white"></i><div class="pulse-ring"></div></div>
        <h2 class="text-2xl font-bold text-white mt-10 brand-font" id="listening-title">Rhythm</h2>
        <p class="text-gray-400 mt-2" id="listening-subtitle">Identifying music...</p>
        <button onclick="cancelListening()" class="mt-8 px-6 py-2 rounded-full border border-gray-600 text-gray-400 hover:text-white hover:border-white transition-all uppercase text-xs tracking-widest">Cancel</button>
    </div>

    <!-- MENU POPUP (NEW) -->
    <div id="track-menu">
        <div class="menu-item" onclick="menuAction('queue')"><i data-lucide="list" class="w-4 h-4"></i> Add to Queue</div>
        <div class="menu-item" onclick="menuAction('playlist')"><i data-lucide="list-plus" class="w-4 h-4"></i> Add to Playlist</div>
    </div>

    <div id="playlist-modal" class="modal-overlay"><div class="modal-box"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-white">Add to Playlist</h3><button onclick="closePlaylistModal()" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button></div><div id="playlist-options" class="max-h-60 overflow-y-auto custom-scroll mb-6"></div><button onclick="openCreatePlaylistModal()" class="w-full py-3 rounded-xl bg-white hover:bg-gray-200 text-black font-bold flex items-center justify-center gap-2 transition-colors"><i data-lucide="plus" class="w-4 h-4"></i> Create New Playlist</button></div></div>
    <div id="create-playlist-modal" class="modal-overlay"><div class="modal-box"><div class="flex justify-between items-center mb-2"><h3 class="text-xl font-bold text-white">New Playlist</h3><button onclick="closeCreatePlaylistModal()" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button></div><p class="text-gray-400 text-sm mb-4">Give your new collection a name.</p><input type="text" id="new-playlist-input" class="vibe-input" placeholder="e.g., Late Night Drive" autocomplete="off"><div class="flex gap-3 mt-8"><button onclick="closeCreatePlaylistModal()" class="flex-1 py-3 rounded-xl border border-gray-700 text-white font-medium hover:bg-gray-800 transition-colors">Cancel</button><button onclick="confirmCreatePlaylist()" class="flex-1 py-3 rounded-xl bg-white text-black font-bold hover:bg-gray-200 transition-colors">Create</button></div></div></div>
    
    <!-- REDESIGNED VIBE AI DIALOG -->
    <div id="ai-playlist-modal" class="modal-overlay">
        <div class="modal-box relative">
            <div class="flex items-start justify-between mb-4 relative z-10">
                <div>
                    <h3 class="text-2xl font-bold ai-gradient-text brand-font mb-1">Vibe AI Agent</h3>
                    <p class="text-xs text-gray-400 uppercase tracking-widest">Powered by Gemini 2.5 Flash</p>
                </div>
                <button onclick="document.getElementById('ai-playlist-modal').classList.remove('active')" class="text-gray-400 hover:text-white p-1"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <p class="text-gray-300 text-sm mb-3 relative z-10">Describe your scenario, feeling, or abstract concept.</p>
            
            <div class="flex flex-wrap gap-2 mb-4 relative z-10">
                <span class="chip" onclick="setAiPrompt('Cyberpunk city raining neon lights')">üåÉ Cyberpunk</span>
                <span class="chip" onclick="setAiPrompt('Coffee shop jazz in Paris 1950')">‚òï Paris Jazz</span>
                <span class="chip" onclick="setAiPrompt('High intensity workout phonk')">‚ö° Workout</span>
                <span class="chip" onclick="setAiPrompt('Sad heartbreak rainy day')">üåßÔ∏è Heartbreak</span>
            </div>

            <textarea id="ai-playlist-prompt" class="vibe-input h-24 text-lg font-medium bg-black/30 focus:bg-black/50 border-white/10 focus:border-purple-500/50 relative z-10" placeholder="Type your vibe here..." style="resize: none;"></textarea>
            
            <div class="mt-6 relative z-10">
                <button onclick="generateAIPlaylist()" id="ai-gen-btn" class="w-full py-4 rounded-xl bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold hover:opacity-90 transition-opacity flex items-center justify-center gap-2 shadow-lg shadow-purple-900/20">
                    <i data-lucide="sparkles" class="w-5 h-5"></i> Generate Experience
                </button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay"><div class="modal-box"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-white">Settings</h3><button onclick="closeSettings()" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="space-y-4 text-left"><div class="flex items-center justify-between"><span class="text-gray-300">High Quality Audio</span><div class="w-10 h-5 bg-green-500 rounded-full relative cursor-pointer"><div class="w-3 h-3 bg-white rounded-full absolute right-1 top-1"></div></div></div><div class="flex items-center justify-between"><span class="text-gray-300">Animations</span><div class="w-10 h-5 bg-green-500 rounded-full relative cursor-pointer"><div class="w-3 h-3 bg-white rounded-full absolute right-1 top-1"></div></div></div><hr class="border-[#333]"><div class="flex items-center justify-between cursor-pointer hover:text-white text-gray-400"><span>Account</span><i data-lucide="chevron-right" class="w-4 h-4"></i></div></div></div></div>
    
    <div id="toast">
        <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
        <span id="toast-msg">Action Completed</span>
    </div>

    <!-- Main App -->
    <div id="main-app-container" class="flex flex-1 overflow-hidden relative z-10" style="display: none; opacity: 0; transition: opacity 0.5s ease;">
        
        <!-- Sidebar: REDESIGNED & COMPACTED -->
        <aside class="w-64 flex flex-col pt-5 px-4 hidden md:flex border-r border-white/10 bg-black/40 backdrop-blur-xl h-full">
            <!-- Brand -->
            <div class="px-4 mb-6 flex items-center gap-3 flex-none">
                <div class="w-10 h-10 border border-white/20 rounded-full flex items-center justify-center bg-white/5"><i data-lucide="audio-waveform" class="w-5 h-5 text-white"></i></div>
                <h1 class="text-xl sidebar-header text-white">Vibe</h1>
            </div>
            
            <!-- Mode Switch -->
            <div class="mode-switch flex-none">
                <div id="mode-music" class="mode-option active" onclick="switchAppMode('music')">Music</div>
                <div id="mode-video" class="mode-option" onclick="switchAppMode('video')">Video</div>
            </div>

            <!-- Navigation (Slimmer) -->
            <nav class="space-y-1 mb-4 flex-none">
                <button id="nav-home" onclick="navAction('home', this)" class="nav-btn active-nav w-full flex items-center gap-4 px-4 py-2 rounded-lg text-gray-400 hover:text-white hover:bg-white/10 font-medium transition-all"><i data-lucide="home" class="w-5 h-5"></i> Home</button>
                <button id="nav-search" onclick="navAction('search', this)" class="nav-btn w-full flex items-center gap-4 px-4 py-2 rounded-lg text-gray-400 hover:text-white hover:bg-white/10 font-medium transition-all"><i data-lucide="search" class="w-5 h-5"></i> Search</button>
                <button id="nav-library" onclick="navAction('library', this)" class="nav-btn w-full flex items-center gap-4 px-4 py-2 rounded-lg text-gray-400 hover:text-white hover:bg-white/10 font-medium transition-all"><i data-lucide="heart" class="w-5 h-5"></i> Liked Songs</button>
                <button onclick="document.getElementById('ai-playlist-modal').classList.add('active')" class="nav-btn w-full flex items-center gap-4 px-4 py-2 rounded-lg text-gray-400 hover:text-white hover:bg-white/10 font-medium transition-all group">
                    <i data-lucide="sparkles" class="w-5 h-5 text-purple-400 group-hover:text-purple-300"></i> <span class="ai-gradient-text font-bold">Vibe AI</span>
                </button>
                <button id="nav-settings" onclick="openSettings()" class="nav-btn w-full flex items-center gap-4 px-4 py-2 rounded-lg text-gray-400 hover:text-white hover:bg-white/10 font-medium transition-all"><i data-lucide="settings" class="w-5 h-5"></i> Settings</button>
            </nav>
            
            <!-- SCROLLABLE AREA START -->
            <div class="px-4 flex-1 overflow-y-auto custom-scroll flex flex-col pb-4">
                
                <!-- MY PLAYLISTS (Takes available space) -->
                <div class="flex-1 mb-4">
                    <div class="flex items-center justify-between mb-4 border-b border-white/10 pb-2 top-0 bg-transparent sticky z-10">
                        <p class="text-xs font-bold text-gray-500 tracking-widest uppercase">My Playlists</p>
                        <button onclick="openCreatePlaylistModal()" class="text-gray-400 hover:text-white transition-transform hover:scale-110"><i data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                    <div id="sidebar-playlists" class="space-y-2">
                        <!-- Dynamic Playlists will populate here -->
                    </div>
                </div>

                <!-- VISUAL DIVIDER -->
                <div class="h-px bg-gradient-to-r from-transparent via-white/10 to-transparent my-4 flex-none"></div>

                <!-- CURATED CARDS (Redesigned - Pinned to bottom visual flow) -->
                <div class="flex-none">
                    <p class="text-xs font-bold text-gray-500 tracking-widest uppercase mb-3 pl-1 flex items-center gap-2"><i data-lucide="radio" class="w-3 h-3 text-purple-400"></i> Curated Mixes</p>
                    <div class="grid gap-3">
                        
                        <!-- Bollywood Card -->
                        <div class="curated-card curated-item group w-full p-3 rounded-xl bg-white/5 cursor-pointer relative overflow-hidden flex items-center gap-3" onclick="loadCurated('bollywood hits', 'Bollywood')">
                            <div class="absolute inset-0 bg-gradient-to-r from-orange-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-orange-400 to-red-600 flex items-center justify-center text-white shadow-lg curated-icon-box transition-transform duration-300 relative z-10">
                                <i data-lucide="clapperboard" class="w-5 h-5 fill-white/20"></i>
                            </div>
                            <div class="flex flex-col relative z-10">
                                <span class="text-sm font-bold text-gray-200 group-hover:text-white">Bollywood</span>
                                <span class="text-[10px] text-gray-500 uppercase tracking-wide">Desi Hits</span>
                            </div>
                        </div>

                        <!-- Top 50 Card -->
                        <div class="curated-card curated-item group w-full p-3 rounded-xl bg-white/5 cursor-pointer relative overflow-hidden flex items-center gap-3" onclick="loadCurated('top hits 2024', 'Global Charts')">
                            <div class="absolute inset-0 bg-gradient-to-r from-blue-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-400 to-cyan-500 flex items-center justify-center text-white shadow-lg curated-icon-box transition-transform duration-300 relative z-10">
                                <i data-lucide="globe" class="w-5 h-5"></i>
                            </div>
                            <div class="flex flex-col relative z-10">
                                <span class="text-sm font-bold text-gray-200 group-hover:text-white">Global Top 50</span>
                                <span class="text-[10px] text-gray-500 uppercase tracking-wide">Trending</span>
                            </div>
                        </div>

                        <!-- Lofi Card -->
                        <div class="curated-card curated-item group w-full p-3 rounded-xl bg-white/5 cursor-pointer relative overflow-hidden flex items-center gap-3" onclick="loadCurated('lofi beats', 'Lo-Fi Focus')">
                            <div class="absolute inset-0 bg-gradient-to-r from-emerald-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-emerald-400 to-teal-600 flex items-center justify-center text-white shadow-lg curated-icon-box transition-transform duration-300 relative z-10">
                                <i data-lucide="coffee" class="w-5 h-5"></i>
                            </div>
                            <div class="flex flex-col relative z-10">
                                <span class="text-sm font-bold text-gray-200 group-hover:text-white">Lo-Fi Study</span>
                                <span class="text-[10px] text-gray-500 uppercase tracking-wide">Focus Mode</span>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative overflow-hidden">
            <!-- Header: Transparent -->
            <header class="h-20 flex items-center justify-between px-8 z-30 bg-transparent">
                <div class="relative w-96 group z-50">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><i data-lucide="search" class="w-4 h-4 text-gray-500 group-focus-within:text-white transition-colors"></i></div>
                    <!-- FIX: Removed problematic onfocus/onblur typewriter logic that halted interaction -->
                    <input type="text" id="search-input" class="block w-full pl-11 pr-10 py-3 rounded-lg bg-black/20 backdrop-blur text-white placeholder-gray-500 focus:outline-none focus:bg-black/50 focus:ring-1 focus:ring-white/20 border border-white/10 transition-all" placeholder="What you wanna listen?" autocomplete="off">
                    <button onclick="startVoiceSearch()" class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer hover:text-white text-gray-500 transition-colors" title="Voice Search"><i data-lucide="mic" class="w-4 h-4"></i></button>
                    <div id="search-suggestions" class="custom-scroll"></div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="startRhythm()" class="rhythm-btn" title="Rhythm - Identify Music"><i data-lucide="radio" class="w-5 h-5 text-white"></i></button>
                    <button onclick="showNotification('No new notifications', 'bell')" class="w-10 h-10 rounded-full bg-black/30 border border-white/10 flex items-center justify-center hover:bg-black/50 transition-colors hover:border-white/20"><i data-lucide="bell" class="w-4 h-4 text-gray-400"></i></button>
                    <div class="w-10 h-10 rounded-full bg-gradient-to-b from-[#444] to-[#111] border border-[#333] flex items-center justify-center font-bold text-xs text-gray-300 cursor-pointer" onclick="openSettings()">VB</div>
                </div>
            </header>
            <div class="flex-1 overflow-y-auto p-8 custom-scroll" id="main-area">
                <div class="mb-8 pb-4 border-b border-white/10 flex justify-between items-end">
                    <div><h2 id="page-title">Discover</h2><p class="text-gray-500 text-sm" id="status-text">Explore infinite possibilities</p></div>
                </div>
                
                <div id="loader" class="w-full py-32 flex items-center justify-center hidden"><div class="flex gap-1"><div class="w-1 h-8 bg-white animate-[pulse_1s_ease-in-out_infinite]"></div><div class="w-1 h-8 bg-white animate-[pulse_1s_ease-in-out_0.2s_infinite]"></div><div class="w-1 h-8 bg-white animate-[pulse_1s_ease-in-out_0.4s_infinite]"></div></div></div>
                
                <!-- CONTENT SECTIONS (NETFLIX STYLE) -->
                <div id="content-sections">
                    <!-- Sections will be injected here dynamically -->
                </div>

                <!-- SEARCH VIEW (Hidden by Default) -->
                <div id="search-view" class="hidden pb-24">
                    <h3 class="text-xl font-bold text-white mb-4 brand-font">Browse All</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                        <div class="browse-card bg-[#E8115B]" onclick="fetchTracks('Pop hits')"><div class="browse-title">Pop</div><img src="https://placehold.co/100x100?text=Pop"></div>
                        <div class="browse-card bg-[#148A08]" onclick="fetchTracks('Hip-Hop')"><div class="browse-title">Hip-Hop</div><img src="https://placehold.co/100x100?text=Rap"></div>
                        <div class="browse-card bg-[#1D75DE]" onclick="fetchTracks('Rock classics')"><div class="browse-title">Rock</div><img src="https://placehold.co/100x100?text=Rock"></div>
                        <div class="browse-card bg-[#777777]" onclick="fetchTracks('Indie music')"><div class="browse-title">Indie</div><img src="https://placehold.co/100x100?text=Indie"></div>
                        <div class="browse-card bg-[#BC5900]" onclick="fetchTracks('Latin hits')"><div class="browse-title">Latin</div><img src="https://placehold.co/100x100?text=Latin"></div>
                        <div class="browse-card bg-[#E91429]" onclick="fetchTracks('Workout music')"><div class="browse-title">Workout</div><img src="https://placehold.co/100x100?text=Fit"></div>
                        <div class="browse-card bg-[#8D67AB]" onclick="fetchTracks('K-Pop hits')"><div class="browse-title">K-Pop</div><img src="https://placehold.co/100x100?text=KPop"></div>
                        <div class="browse-card bg-[#D84000]" onclick="fetchTracks('Jazz classics')"><div class="browse-title">Jazz</div><img src="https://placehold.co/100x100?text=Jazz"></div>
                        <div class="browse-card bg-[#537AA1]" onclick="fetchTracks('Classical study')"><div class="browse-title">Classical</div><img src="https://placehold.co/100x100?text=Piano"></div>
                        <div class="browse-card bg-[#509BF5]" onclick="fetchTracks('Electronic dance')"><div class="browse-title">Dance/Electronic</div><img src="https://placehold.co/100x100?text=EDM"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- RIGHT PANEL: GLASSED -->
        <aside id="right-panel" class="right-panel custom-scroll flex flex-col h-full">
            <!-- Top Section (Fixed) -->
            <div class="flex-none p-1">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex gap-4">
                        <span id="tab-queue" class="panel-tab active" onclick="switchRightTab('queue')">Queue</span>
                        <span id="tab-lyrics" class="panel-tab" onclick="switchRightTab('lyrics')">Lyrics</span>
                    </div>
                    <button onclick="toggleRightPanel()" class="text-gray-400 hover:text-white p-2 rounded hover:bg-white/10 transition-colors"><i data-lucide="minimize-2" class="w-5 h-5"></i></button>
                </div>
                
                <!-- PREVIEW CONTAINER -->
                <div id="preview-container" class="preview-container">
                    <img id="side-art" src="" class="w-full h-full object-cover">
                    <div id="video-player-container" class="hidden w-full h-full bg-black"></div>
                </div>
                
                <div class="mb-6 text-center"><h2 id="side-title" class="text-xl font-bold text-white leading-tight mb-1">Select a Track</h2><p id="side-artist" class="text-md text-gray-400">Vibe Audio Engine</p></div>
            </div>

            <!-- Bottom Section -->
            <div class="flex-1 overflow-y-auto custom-scroll min-h-0 flex flex-col">
                <!-- QUEUE -->
                <div id="queue-content" class="active flex-1 custom-scroll">
                    <div class="p-4 bg-black/20 rounded-lg border border-white/5 h-full flex flex-col">
                        <div class="flex justify-between items-center mb-3 flex-none"><p class="text-xs font-bold text-gray-500 uppercase tracking-widest">Up Next</p><span class="text-xs text-gray-500" id="queue-count">0 tracks</span></div>
                        <div id="queue-list" class="space-y-2 overflow-y-auto flex-1 custom-scroll"><div class="text-gray-500 text-sm italic text-center py-4">No upcoming tracks</div></div>
                    </div>
                </div>
                <!-- LYRICS / AI ANALYSIS -->
                <div id="lyrics-container" class="flex-1 custom-scroll">
                    <div class="text-center mb-4">
                        <button onclick="analyzeCurrentTrack()" id="analyze-btn" class="text-xs border border-white/20 hover:bg-white/10 text-purple-300 px-3 py-1.5 rounded-full transition-colors flex items-center gap-1 mx-auto">
                            <i data-lucide="sparkles" class="w-3 h-3"></i> Deep Dive Analysis
                        </button>
                        <div id="analysis-result" class="hidden text-left"></div>
                    </div>
                    <div id="lyrics-text" class="text-center text-white"></div>
                </div>
            </div>
        </aside>
    </div>

    <footer id="app-playbar" class="playbar flex items-center justify-between" style="display: none; opacity: 0; transition: opacity 1s ease;">
        <div class="flex items-center gap-4 w-[30%] min-w-[200px]">
            <div class="relative group cursor-pointer" onclick="toggleRightPanel()"><img id="footer-art" src="https://placehold.co/64x64/111/333?text=V" class="w-14 h-14 rounded shadow-md object-cover bg-[#111] border border-[#222]"><div class="absolute inset-0 bg-black/60 rounded flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="chevron-up" class="w-6 h-6 text-white"></i></div></div>
            <div class="flex flex-col justify-center"><h4 id="footer-title" class="text-sm font-semibold text-white hover:underline cursor-pointer truncate max-w-[180px]">Not Playing</h4><p id="footer-artist" class="text-xs text-gray-400 hover:text-white hover:underline cursor-pointer truncate max-w-[180px]">Select a song</p></div>
            <button id="fav-btn" onclick="toggleFavoriteCurrent()" class="text-gray-500 hover:text-red-500 transition-colors ml-2"><i data-lucide="heart" class="w-4 h-4"></i></button>
        </div>
        <div class="flex flex-col items-center max-w-[40%] w-full gap-2">
            <div class="flex items-center gap-6">
                <button id="shuffle-btn" onclick="toggleShuffle()" class="text-gray-500 hover:text-white transition-colors"><i data-lucide="shuffle" class="w-4 h-4"></i></button>
                <button onclick="playPrev()" class="text-gray-400 hover:text-white transition-colors"><i data-lucide="skip-back" class="w-5 h-5 fill-current"></i></button>
                <button onclick="togglePlay()" class="w-10 h-10 bg-white rounded-full flex items-center justify-center hover:scale-105 transition-transform shadow-[0_0_15px_rgba(255,255,255,0.3)]"><div id="play-icon"><i data-lucide="play" class="w-4 h-4 fill-black text-black ml-0.5"></i></div></button>
                <button onclick="playNext()" class="text-gray-400 hover:text-white transition-colors"><i data-lucide="skip-forward" class="w-5 h-5 fill-current"></i></button>
                <button id="repeat-btn" onclick="toggleRepeat()" class="text-gray-500 hover:text-white transition-colors relative"><i id="repeat-icon" data-lucide="repeat" class="w-4 h-4"></i></button>
            </div>
            <div class="flex items-center gap-3 w-full text-xs font-medium text-gray-500 slider-group"><span id="curr-time" class="min-w-[35px] text-right font-mono">0:00</span><input type="range" id="seek-slider" min="0" max="1000" value="0" step="1"><span id="total-time" class="min-w-[35px] font-mono">0:00</span></div>
        </div>
        <div class="flex items-center justify-end gap-3 w-[30%] min-w-[200px]">
            <div id="mini-viz" class="music-wave-icon paused mr-2"><div class="wave-bar" style="animation-delay: 0s"></div><div class="wave-bar" style="animation-delay: 0.2s"></div><div class="wave-bar" style="animation-delay: 0.4s"></div><div class="wave-bar" style="animation-delay: 0.1s"></div></div>
            <button onclick="toggleRightPanel()" id="expand-btn" class="text-gray-400 hover:text-white" title="Open Side View"><i data-lucide="maximize-2" class="w-4 h-4"></i></button>
            <div class="flex items-center gap-2 w-28 slider-group"><i id="vol-icon" data-lucide="volume-2" class="w-4 h-4 text-gray-400"></i><input type="range" id="vol-slider" min="0" max="100" value="100"></div>
        </div>
    </footer>

    <audio id="audio-player" crossorigin="anonymous"></audio>

    <script>
        const apiKey = "AIzaSyDWvbbzthZfdUotpHjC-0B8PJrMdCM1Z_0"; // Environment key
        const YOUTUBE_API_KEY = 'AIzaSyCU3UPAUKVeuUQB62QCudEkkP60WYPnNt8';
        const ITUNES_API = 'https://itunes.apple.com/search';
        let appMode = 'music'; 
        let masterList = [], currentGrid = [], currentTrackId = null, favorites = new Set(), userPlaylists = [], currentSection = 'discover';
        let playQueue = [], queueIndex = -1, isDraggingSeek = false, trackToAdd = null;
        let isShuffle = false;
        let repeatMode = 0; // 0: Off, 1: All, 2: One
        
        // Popular Artists Data (Stable URLs + Fallback)
        const popularArtists = [
            { name: "The Weeknd", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/e/e8/The_Weeknd_at_the_Cannes_Film_Festival_2023_%28cropped%29.jpg/440px-The_Weeknd_at_the_Cannes_Film_Festival_2023_%28cropped%29.jpg" },
            { name: "Taylor Swift", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/b/b5/191125_Taylor_Swift_at_the_2019_American_Music_Awards.png/440px-191125_Taylor_Swift_at_the_2019_American_Music_Awards.png" },
            { name: "Drake", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/2/28/Drake_July_2016.jpg/440px-Drake_July_2016.jpg" },
            { name: "Ariana Grande", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/dd/Ariana_Grande_Grammys_Red_Carpet_2020.png/440px-Ariana_Grande_Grammys_Red_Carpet_2020.png" },
            { name: "Justin Bieber", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/da/Justin_Bieber_in_2015.jpg/440px-Justin_Bieber_in_2015.jpg" },
            { name: "Dua Lipa", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/1/1c/Dua_Lipa_at_Capital_Jingle_Bell_Ball_2017_%28cropped%29.jpg/440px-Dua_Lipa_at_Capital_Jingle_Bell_Ball_2017_%28cropped%29.jpg" },
            { name: "Post Malone", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c9/Post_Malone_Stavernfestivalen_2018_%28221617%29.jpg/440px-Post_Malone_Stavernfestivalen_2018_%28221617%29.jpg" },
            { name: "Billie Eilish", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/f/fa/Billie_Eilish_2019_by_Glenn_Francis_%28cropped%29_2.jpg/440px-Billie_Eilish_2019_by_Glenn_Francis_%28cropped%29_2.jpg" }
        ];

        const discoveryPool = [
             { title: "Global Charts", term: "top 100 global" },
             { title: "Viral Hits", term: "viral tiktok songs" },
             { title: "New Releases", term: "new music friday" },
             { title: "Hip-Hop Heavyweights", term: "hip hop hits" },
             { title: "Pop Anthems", term: "pop chart toppers" },
             { title: "Indie Vibes", term: "indie pop alternative" },
             { title: "Rock Classics", term: "classic rock greatest hits" },
             { title: "Latin Heat", term: "reggaeton latino hits" },
             { title: "K-Pop Wave", term: "kpop bts blackpink" },
             { title: "Electronic Energy", term: "edm festival hits" },
             { title: "Chill & Relax", term: "acoustic chill lofi" },
             { title: "Focus Flow", term: "study music classical" },
             { title: "Workout Pump", term: "workout motivation high energy" },
             { title: "Throwback 2000s", term: "2000s hits nostalgia" },
             { title: "R&B Soul", term: "r&b soul classics" },
             { title: "Jazz Lounge", term: "smooth jazz cafe" },
             { title: "Country Roads", term: "country top hits" },
             { title: "Alt Rock Essentials", term: "alternative rock 90s" },
             { title: "Synthwave Drive", term: "synthwave retrowave" },
             { title: "Piano Dreams", term: "piano solo relaxing" }
        ];

        const audio = document.getElementById('audio-player'), contentSections = document.getElementById('content-sections'), loader = document.getElementById('loader'), seekSlider = document.getElementById('seek-slider'), volSlider = document.getElementById('vol-slider');

        // Helper to pick N random categories
        function getRandomCategories(n) {
            const shuffled = [...discoveryPool].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, n);
        }

        function toggleShuffle() {
            isShuffle = !isShuffle;
            const btn = document.getElementById('shuffle-btn');
            if (isShuffle) {
                btn.classList.remove('text-gray-500');
                btn.classList.add('text-purple-400');
                if (playQueue.length > 0) {
                    for (let i = playQueue.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [playQueue[i], playQueue[j]] = [playQueue[j], playQueue[i]];
                    }
                    renderQueue();
                }
            } else {
                btn.classList.add('text-gray-500');
                btn.classList.remove('text-purple-400');
                if (currentTrackId && currentGrid.length > 0) {
                    const idx = currentGrid.findIndex(t => t.trackId === currentTrackId);
                    if(idx !== -1) {
                        playQueue = currentGrid.slice(idx + 1);
                        renderQueue();
                    }
                }
            }
        }

        function toggleRepeat() {
            repeatMode = (repeatMode + 1) % 3;
            const btn = document.getElementById('repeat-btn');
            const icon = document.getElementById('repeat-icon');
            if (repeatMode === 0) {
                btn.classList.add('text-gray-500');
                btn.classList.remove('text-purple-400');
                icon.innerHTML = '<polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path>';
            } else if (repeatMode === 1) {
                btn.classList.remove('text-gray-500');
                btn.classList.add('text-purple-400');
                icon.innerHTML = '<polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path>';
            } else {
                btn.classList.remove('text-gray-500');
                btn.classList.add('text-purple-400');
                icon.innerHTML = '<polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path><text x="10" y="15" font-size="8" fill="currentColor" font-family="sans-serif" font-weight="bold">1</text>'; 
            }
        }

        // --- GEMINI UTILS ---
        async function callGemini(prompt) {
            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    }
                );
                if (!response.ok) throw new Error(`API Error`);
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (error) { return null; }
        }

        function setAiPrompt(text) {
            document.getElementById('ai-playlist-prompt').value = text;
        }

        async function generateAIPlaylist() {
            const promptInput = document.getElementById('ai-playlist-prompt');
            const prompt = promptInput.value.trim();
            if (!prompt) { showNotification("Please enter a vibe description!", "alert-circle"); return; }
            const btn = document.getElementById('ai-gen-btn');
            const originalBtnText = btn.innerHTML;
            btn.innerHTML = `<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div> Consultng AI...`;
            btn.disabled = true;
            const aiPrompt = `You are a music curator. Generate a playlist of 6 songs based on this mood/prompt: '${prompt}'. Return ONLY a raw valid JSON array (no markdown, no code blocks) where each object has exactly two fields: "title" and "artist". Example: [{"title":"Song1","artist":"Artist1"}]`;
            try {
                const resultText = await callGemini(aiPrompt);
                if (!resultText) throw new Error("No data");
                const jsonMatch = resultText.match(/\[.*\]/s);
                if (!jsonMatch) throw new Error("Invalid format");
                const tracks = JSON.parse(jsonMatch[0]);
                document.getElementById('ai-playlist-modal').classList.remove('active');
                document.getElementById('page-title').innerHTML = `‚ú® Vibe AI: ${prompt.substring(0, 20)}...`;
                document.getElementById('status-text').textContent = "Curating your acoustic environment...";
                document.getElementById('search-view').classList.add('hidden');
                contentSections.classList.remove('hidden');
                loader.classList.remove('hidden');
                contentSections.innerHTML = '';
                const realTracks = [];
                for (const t of tracks) {
                    try {
                        const res = await fetch(`${ITUNES_API}?term=${encodeURIComponent(t.title + " " + t.artist)}&media=music&entity=song&limit=1`);
                        const data = await res.json();
                        if (data.results && data.results.length > 0) {
                            const track = data.results[0];
                            if (!masterList.find(m => m.trackId === track.trackId)) masterList.push(track);
                            realTracks.push(track);
                        }
                    } catch (e) {}
                }
                renderCategoryRow("AI Curated Mix", realTracks);
                document.getElementById('status-text').textContent = `AI curated ${realTracks.length} songs for you.`;
                showNotification("Playlist Generated!", "sparkles");
            } catch (e) {
                showNotification("AI Gen Failed.", "x-circle");
            } finally {
                btn.innerHTML = originalBtnText;
                btn.disabled = false;
                loader.classList.add('hidden');
            }
        }

        async function analyzeCurrentTrack() {
            if (!currentTrackId) return;
            const track = masterList.find(t => t.trackId === currentTrackId);
            if (!track) return;
            const resultBox = document.getElementById('analysis-result');
            resultBox.classList.remove('hidden');
            resultBox.innerHTML = '<div class="animate-pulse text-gray-500 text-xs text-center mt-4">Consulting the Vibe Engine...</div>';
            const prompt = `Briefly explain the meaning and emotional vibe of the song "${track.trackName}" by "${track.artistName}" in 2-3 sentences. Focus on the feeling.`;
            const analysis = await callGemini(prompt);
            if (analysis) {
                resultBox.innerHTML = `<div class="ai-response-box"><div class="text-xs font-bold text-purple-300 mb-2 flex items-center gap-2"><i data-lucide="bot" class="w-3 h-3"></i> Vibe Analysis</div>${marked.parse(analysis)}</div>`;
            } else {
                resultBox.innerHTML = '<div class="text-red-500 text-xs mt-2">Analysis unavailable.</div>';
            }
        }

        function switchAppMode(mode) {
            appMode = mode;
            document.querySelectorAll('.mode-option').forEach(el => el.classList.remove('active'));
            document.getElementById(`mode-${mode}`).classList.add('active');
            if (mode === 'music') { document.getElementById('page-title').textContent = 'Discover'; fetchTracks(null); } 
            else { document.getElementById('page-title').textContent = 'Trending Videos'; fetchTracks('trending music videos'); }
        }

        function scrollRow(btn, direction) {
            const container = btn.parentElement.querySelector('.horizontal-scroll');
            const scrollAmount = 600;
            container.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });
        }

        // NEW: Render Popular Artists Row with SWIPE ARROWS
        function renderPopularArtists() {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'mb-12 relative group';

            const headerDiv = document.createElement('div');
            headerDiv.className = 'section-header';
            headerDiv.innerHTML = `<h3 class="section-title">Popular Artists</h3>`;
            sectionDiv.appendChild(headerDiv);

            // Added Navigation Buttons
            const leftBtn = document.createElement('button');
            leftBtn.className = 'scroll-btn left hidden';
            leftBtn.innerHTML = '<i data-lucide="chevron-left" class="w-6 h-6"></i>';
            leftBtn.onclick = function() { scrollRow(this, -1); };
            
            const rightBtn = document.createElement('button');
            rightBtn.className = 'scroll-btn right hidden'; 
            rightBtn.innerHTML = '<i data-lucide="chevron-right" class="w-6 h-6"></i>';
            rightBtn.onclick = function() { scrollRow(this, 1); };

            const scrollContainer = document.createElement('div');
            scrollContainer.className = 'horizontal-scroll custom-scroll';
            
            // ADDED ONERROR HANDLER FOR ARTIST IMAGES
            scrollContainer.innerHTML = popularArtists.map(artist => `
                <div class="artist-card" onclick="loadArtist('${artist.name}')">
                    <div class="artist-img-container">
                        <img src="${artist.img}" class="artist-img img-fade" onload="this.classList.add('loaded')" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(artist.name)}&background=random&color=fff&size=200'">
                    </div>
                    <span class="artist-name">${artist.name}</span>
                </div>
            `).join('');

            sectionDiv.appendChild(leftBtn);
            sectionDiv.appendChild(scrollContainer);
            sectionDiv.appendChild(rightBtn);
            
            contentSections.appendChild(sectionDiv);

            scrollContainer.addEventListener('scroll', () => {
                 leftBtn.style.display = scrollContainer.scrollLeft > 0 ? 'flex' : 'none';
            });
            leftBtn.style.display = 'none';
            rightBtn.style.display = 'flex';
        }

        async function loadArtist(artistName) {
            document.getElementById('page-title').textContent = artistName;
            document.getElementById('status-text').textContent = "Loading discography...";
            contentSections.innerHTML = '';
            
            // SKELETON LOADING GRID
            const gridContainer = document.createElement('div');
            gridContainer.className = 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6';
            gridContainer.innerHTML = Array(10).fill(0).map(() => `
                <div class="song-card" style="border:none; background:transparent;">
                    <div class="skeleton w-full h-full"></div>
                </div>
            `).join('');
            contentSections.appendChild(gridContainer);

            try {
                const res = await fetch(`${ITUNES_API}?term=${encodeURIComponent(artistName)}&media=music&entity=song&limit=40`);
                const data = await res.json();
                let tracks = data.results;
                // FIX: ADD TO MASTERLIST
                tracks.forEach(t => { if (!masterList.find(m => m.trackId === t.trackId)) masterList.push(t); });
                expandCategory(artistName, tracks); 
                currentGrid = tracks;
                document.getElementById('status-text').textContent = "Top Songs";
            } catch(e) { console.error(e); }
        }

        function expandCategory(title, tracks, isArtistMode = false) {
            currentSection = 'expanded';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            document.getElementById('page-title').textContent = title;
            document.getElementById('status-text').textContent = `Browsing all ${tracks.length} tracks`;
            contentSections.innerHTML = '';
            
            const backBtn = document.createElement('button');
            backBtn.className = 'mb-6 flex items-center gap-2 text-gray-400 hover:text-white transition-colors text-sm font-medium uppercase tracking-wider';
            backBtn.innerHTML = '<i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Discover';
            backBtn.onclick = () => {
                navAction('home');
            };
            contentSections.appendChild(backBtn);

            const gridContainer = document.createElement('div');
            gridContainer.className = 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 animate-in';

            gridContainer.innerHTML = tracks.map((t, i) => {
                const highResImg = t.artworkUrl100.replace('100x100', '600x600');
                const originalImg = t.artworkUrl100;
                
                // HEART LOGIC: Check if track is favorite
                const isFav = favorites.has(t.trackId); 
                const heartClass = isFav ? 'liked' : ''; 
                
                return `
                <div class="song-card group/card animate-in" style="animation-delay: ${i * 0.03}s" onclick="playTrack(${t.trackId})">
                    <img src="${highResImg}" loading="lazy" decoding="async" class="card-bg-img img-fade" onload="this.classList.add('loaded')" onerror="this.onerror=null; this.src='${originalImg}';">
                    <div class="card-gradient-overlay"></div>
                    <button class="card-icon-btn pos-tl ${heartClass} like-btn-${t.trackId}" onclick="toggleFromCard(event, ${t.trackId})" title="Like"><i data-lucide="heart" class="w-4 h-4"></i></button>
                    <button class="card-icon-btn pos-tr" onclick="openTrackMenu(event, ${t.trackId})" title="Options"><i data-lucide="more-vertical" class="w-4 h-4 text-white"></i></button>
                    <div class="play-overlay"><i data-lucide="play" class="w-6 h-6 fill-black text-black ml-1"></i></div>
                    <div class="card-content"><div class="card-title">${t.trackName}</div><div class="card-artist">${t.artistName}</div></div>
                </div>`;
            }).join('');

            contentSections.appendChild(gridContainer);
            lucide.createIcons();
        }

        function renderCategoryRow(title, tracks) {
            if (!tracks || tracks.length === 0) return;

            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'mb-8 relative group'; 
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'section-header';
            
            const titleEl = document.createElement('h3');
            titleEl.className = 'section-title';
            titleEl.textContent = title;
            
            const seeAllBtn = document.createElement('button');
            seeAllBtn.className = 'see-all-btn';
            seeAllBtn.innerHTML = '<i data-lucide="chevron-right" class="w-5 h-5"></i>';
            seeAllBtn.title = "View All " + title;
            seeAllBtn.onclick = () => expandCategory(title, tracks);

            headerDiv.appendChild(titleEl);
            headerDiv.appendChild(seeAllBtn);
            sectionDiv.appendChild(headerDiv);

            const leftBtn = document.createElement('button');
            leftBtn.className = 'scroll-btn left hidden';
            leftBtn.innerHTML = '<i data-lucide="chevron-left" class="w-6 h-6"></i>';
            leftBtn.onclick = function() { scrollRow(this, -1); };
            
            const rightBtn = document.createElement('button');
            rightBtn.className = 'scroll-btn right hidden'; 
            rightBtn.innerHTML = '<i data-lucide="chevron-right" class="w-6 h-6"></i>';
            rightBtn.onclick = function() { scrollRow(this, 1); };
            
            const scrollContainer = document.createElement('div');
            scrollContainer.className = 'horizontal-scroll custom-scroll';
            
            scrollContainer.innerHTML = tracks.map((t, i) => {
                const originalImg = t.artworkUrl100;
                const highResImg = t.artworkUrl100.replace('100x100', '400x400');
                const delay = i * 0.05; 
                
                // HEART LOGIC
                const isFav = favorites.has(t.trackId); 
                const heartClass = isFav ? 'liked' : ''; 
                
                return `
                <div class="song-card group/card animate-in" style="animation-delay: ${delay}s" onclick="playTrack(${t.trackId})">
                    <img src="${highResImg}" loading="lazy" decoding="async" class="card-bg-img img-fade" onload="this.classList.add('loaded')" onerror="this.onerror=null; this.src='${originalImg}';">
                    <div class="card-gradient-overlay"></div>
                    <button class="card-icon-btn pos-tl ${heartClass} like-btn-${t.trackId}" onclick="toggleFromCard(event, ${t.trackId})" title="Like"><i data-lucide="heart" class="w-4 h-4"></i></button>
                    <button class="card-icon-btn pos-tr" onclick="openTrackMenu(event, ${t.trackId})" title="Options"><i data-lucide="more-vertical" class="w-4 h-4 text-white"></i></button>
                    <div class="play-overlay"><i data-lucide="play" class="w-6 h-6 fill-black text-black ml-1"></i></div>
                    <div class="card-content"><div class="card-title">${t.trackName}</div><div class="card-artist">${t.artistName}</div></div>
                </div>`;
            }).join('');
            
            sectionDiv.appendChild(leftBtn);
            sectionDiv.appendChild(scrollContainer);
            sectionDiv.appendChild(rightBtn);
            
            contentSections.appendChild(sectionDiv);
            lucide.createIcons();

            scrollContainer.addEventListener('scroll', () => {
                 leftBtn.style.display = scrollContainer.scrollLeft > 0 ? 'flex' : 'none';
            });
            leftBtn.style.display = 'none';
            rightBtn.style.display = 'flex'; 
        }

        // ... existing player logic ...
        function playVideo(videoId, title, artist) {
            const container = document.getElementById('video-player-container');
            const prevContainer = document.getElementById('preview-container');
            prevContainer.classList.add('video-mode'); 
            container.innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&playsinline=1&iv_load_policy=3&fs=0" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>`;
            container.classList.remove('hidden'); container.style.display = 'block'; document.getElementById('side-art').style.display = 'none';
            audio.pause(); setPlayIcon(false);
            document.getElementById('side-title').textContent = title; document.getElementById('side-artist').textContent = artist;
            document.getElementById('footer-title').textContent = title; document.getElementById('footer-artist').textContent = artist;
            document.getElementById('footer-art').src = `https://img.youtube.com/vi/${videoId}/default.jpg`;
            const bg = document.getElementById('art-bg'); bg.style.backgroundImage = `url('https://img.youtube.com/vi/${videoId}/maxresdefault.jpg')`; bg.classList.add('active');
            openRightPanel();
        }

        function switchScreen(fromId, toId) {
            const from = document.getElementById(fromId), to = document.getElementById(toId);
            if(from) { from.style.opacity = '0'; setTimeout(() => { from.classList.remove('visible', 'active-flex'); from.style.display = 'none'; if(to) { to.style.display = 'flex'; to.classList.add('active-flex', 'visible', 'active-screen'); void to.offsetWidth; to.style.opacity = '1'; lucide.createIcons(); } }, 300); }
        }
        function transitionToProfile() { switchScreen('welcome-screen', 'profile-screen'); }
        function transitionToMood(profileName) { switchScreen('profile-screen', 'mood-screen'); }
        function transitionToApp(moodQuery) {
            const moodScreen = document.getElementById('mood-screen'); moodScreen.style.opacity = '0';
            setTimeout(() => {
                moodScreen.classList.remove('visible', 'active-flex'); moodScreen.style.display = 'none';
                document.getElementById('main-app-container').style.display = 'flex'; setTimeout(() => document.getElementById('main-app-container').style.opacity = '1', 50);
                document.getElementById('app-playbar').style.display = 'flex'; setTimeout(() => document.getElementById('app-playbar').style.opacity = '1', 50);
                updateSliderBackground(volSlider); updateSliderBackground(seekSlider); renderSidebarPlaylists(); startTypingAnimation();
                fetchTracks(null); 
            }, 300);
        }
        function selectMood(mood) { transitionToApp(mood); }
        function skipMood() { transitionToApp('top hits 2024'); }

        async function startRhythm() {
            const overlay = document.getElementById('listening-overlay'); document.getElementById('listening-title').textContent = "Rhythm"; document.getElementById('listening-subtitle').textContent = "Identifying music..."; overlay.classList.add('active');
            try { const stream = await navigator.mediaDevices.getUserMedia({ audio: true }); setTimeout(() => { stream.getTracks().forEach(track => track.stop()); overlay.classList.remove('active'); if (masterList.length > 0) { const match = masterList[Math.floor(Math.random() * masterList.length)]; playTrack(match.trackId); showNotification(`Identified: ${match.trackName}`, 'check-circle'); } else { showNotification("No match found in library.", 'alert-circle'); } }, 4000); } catch (err) { overlay.classList.remove('active'); alert("Microphone access required."); }
        }
        async function startVoiceSearch() {
            const overlay = document.getElementById('listening-overlay'); document.getElementById('listening-title').textContent = "Speak Now"; document.getElementById('listening-subtitle').textContent = "Listening..."; overlay.classList.add('active');
            try { const stream = await navigator.mediaDevices.getUserMedia({ audio: true }); setTimeout(() => { stream.getTracks().forEach(track => track.stop()); overlay.classList.remove('active'); const terms = ["The Weeknd", "Taylor Swift", "Coldplay", "Drake", "Arijit Singh"]; const randomTerm = terms[Math.floor(Math.random() * terms.length)]; document.getElementById('search-input').value = randomTerm; fetchTracks(randomTerm); showNotification(`Searching "${randomTerm}"`, 'mic'); }, 3000); } catch (err) { overlay.classList.remove('active'); alert("Microphone access required."); }
        }
        function cancelListening() { document.getElementById('listening-overlay').classList.remove('active'); }

        let typingTimer;
        function startTypingAnimation() {
            const titles = ["What you wanna listen?", "Search for your fav song", "Discover new vibes...", "Find that rhythm...", "Soundtrack your life..."];
            let titleIndex = 0, charIndex = 0, isDeleting = false; const input = document.getElementById('search-input');
            if(typingTimer) clearTimeout(typingTimer);
            function type() {
                if(document.activeElement === input && input.value.length > 0) return;
                const currentTitle = titles[titleIndex];
                if (isDeleting) { input.setAttribute('placeholder', currentTitle.substring(0, charIndex - 1)); charIndex--; } 
                else { input.setAttribute('placeholder', currentTitle.substring(0, charIndex + 1)); charIndex++; }
                let speed = 100;
                if (!isDeleting && charIndex === currentTitle.length) { speed = 2000; isDeleting = true; } 
                else if (isDeleting && charIndex === 0) { isDeleting = false; titleIndex = (titleIndex + 1) % titles.length; speed = 500; }
                else if (isDeleting) { speed = 50; }
                typingTimer = setTimeout(type, speed);
            } 
            type();
        }
        
        let debounce; const searchInput = document.getElementById('search-input'); const suggestionBox = document.getElementById('search-suggestions');
        
        searchInput.addEventListener('focus', () => { clearTimeout(typingTimer); searchInput.setAttribute('placeholder', 'Search...'); });
        searchInput.addEventListener('blur', () => { if(searchInput.value === '') startTypingAnimation(); });

        searchInput.addEventListener('input', (e) => { 
            const val = e.target.value.trim(); 
            clearTimeout(debounce); 
            if (val.length < 2) { suggestionBox.classList.remove('active'); return; } 
            debounce = setTimeout(() => { fetchSuggestions(val); }, 300); 
        });
        
        searchInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') { fetchTracks(e.target.value); suggestionBox.classList.remove('active'); } });
        async function fetchSuggestions(query) { try { const res = await fetch(`${ITUNES_API}?term=${encodeURIComponent(query)}&media=music&entity=song&limit=5`); const data = await res.json(); renderSuggestions(data.results); } catch (e) { console.error(e); } }
        function renderSuggestions(results) { if (!results || results.length === 0) { suggestionBox.classList.remove('active'); return; } results.forEach(t => { if (!masterList.find(m => m.trackId === t.trackId)) masterList.push(t); }); suggestionBox.innerHTML = results.map(t => `<div class="suggestion-item" onclick="playTrack(${t.trackId}); document.getElementById('search-suggestions').classList.remove('active')"><img src="${t.artworkUrl60}" class="w-10 h-10 rounded object-cover"><div class="overflow-hidden"><div class="text-white font-bold text-sm truncate">${t.trackName}</div><div class="text-gray-400 text-xs truncate">${t.artistName}</div></div></div>`).join(''); suggestionBox.classList.add('active'); }
        document.addEventListener('click', (e) => { if (!e.target.closest('#search-input') && !e.target.closest('#search-suggestions')) suggestionBox.classList.remove('active'); });

        // REFACTORED FETCH TRACKS FOR DYNAMIC LAYOUTS
        async function fetchTracks(query, displayTitle) {
            // If User Types a Search -> Show Grid Result
            if (query && !displayTitle && !randomSearchTerms.includes(query)) {
                document.getElementById('search-view').classList.add('hidden');
                contentSections.classList.remove('hidden');
                document.getElementById('page-title').textContent = `Results: ${query}`;
                
                loader.classList.remove('hidden'); 
                contentSections.innerHTML = '';

                try {
                    const res = await fetch(`${ITUNES_API}?term=${encodeURIComponent(query)}&media=music&entity=song&limit=50`); 
                    const data = await res.json();
                    let newTracks = data.results; 
                    newTracks.forEach(t => { if (!masterList.find(m => m.trackId === t.trackId)) masterList.push(t); });
                    currentGrid = newTracks; 
                    // Render as a single horizontal row for results to keep consistency, or grid if preferred. 
                    // User asked for "Netflix style" everywhere.
                    renderCategoryRow("Top Results", newTracks); 
                    document.getElementById('status-text').textContent = `${newTracks.length} tracks found`; 
                } catch (e) { contentSections.innerHTML = '<div class="text-gray-500 col-span-full text-center">Connection failed.</div>'; } finally { loader.classList.add('hidden'); }
            
            } else {
                // DYNAMIC DISCOVERY / SIDEBAR NAVIGATION
                document.getElementById('search-view').classList.add('hidden');
                contentSections.classList.remove('hidden');
                
                // Set proper title
                document.getElementById('page-title').textContent = displayTitle || 'Discover';
                
                loader.classList.remove('hidden');
                contentSections.innerHTML = '';

                // Logic for sidebar clicks (Bollywood, Lofi, etc.) -> Behave like Home but filtered
                if (displayTitle && query) {
                    // It's a specific genre request (e.g. Bollywood)
                    // Create a few "fake" sub-categories to make it feel immersive
                    const subCats = [
                        { title: `Top ${displayTitle}`, term: query },
                        { title: "New & Trending", term: `${query} new` },
                        { title: "Classics", term: `${query} classic` }
                    ];
                    
                    let allFetched = [];
                    await Promise.all(subCats.map(async (cat) => {
                         try {
                            const res = await fetch(`${ITUNES_API}?term=${encodeURIComponent(cat.term)}&media=music&entity=song&limit=25`);
                            const data = await res.json();
                            if(data.results && data.results.length > 0) {
                                const shuffled = data.results.sort(() => 0.5 - Math.random());
                                shuffled.forEach(t => { if (!masterList.find(m => m.trackId === t.trackId)) masterList.push(t); allFetched.push(t); });
                                renderCategoryRow(cat.title, shuffled);
                            }
                        } catch(e) {}
                    }));
                    currentGrid = allFetched;
                    loader.classList.add('hidden');

                } else {
                    // HOME / DEFAULT DISCOVERY
                    // 1. RENDER POPULAR ARTISTS (NEW)
                    renderPopularArtists();

                    // 2. Pick 5 Random Categories from the Big Pool
                    const selectedCategories = getRandomCategories(5);
                    let allFetchedTracks = [];

                    await Promise.all(selectedCategories.map(async (cat) => {
                        try {
                            const res = await fetch(`${ITUNES_API}?term=${encodeURIComponent(cat.term)}&media=music&entity=song&limit=25`); 
                            const data = await res.json();
                            if(data.results && data.results.length > 0) {
                                const shuffledTracks = data.results.sort(() => 0.5 - Math.random());
                                shuffledTracks.forEach(t => { 
                                    if (!masterList.find(m => m.trackId === t.trackId)) masterList.push(t);
                                    allFetchedTracks.push(t);
                                });
                                renderCategoryRow(cat.title, shuffledTracks);
                            }
                        } catch(e) { console.error(e); }
                    }));
                    
                    currentGrid = allFetchedTracks; 
                    loader.classList.add('hidden');
                }
            }
        }
        
        let trackIdForMenu = null;
        function openTrackMenu(e, id) {
            e.stopPropagation();
            trackIdForMenu = id;
            const menu = document.getElementById('track-menu');
            const rect = e.target.closest('button').getBoundingClientRect();
            menu.style.top = `${rect.bottom + 5}px`;
            menu.style.left = `${rect.left - 140}px`;
            menu.classList.add('active');
            const closeMenu = (e) => {
                if (!e.target.closest('#track-menu') && !e.target.closest('.pos-tr')) {
                    menu.classList.remove('active');
                    document.removeEventListener('click', closeMenu);
                }
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 100);
        }

        function menuAction(action) {
            if (!trackIdForMenu) return;
            if (action === 'queue') {
                const track = masterList.find(t => t.trackId === trackIdForMenu);
                if (track) { playQueue.push(track); renderQueue(); updatePreviewMode(); showNotification('Added to Queue', 'list'); }
            } else if (action === 'playlist') {
                trackToAdd = trackIdForMenu;
                renderPlaylistOptions();
                document.getElementById('playlist-modal').classList.add('active');
            }
            document.getElementById('track-menu').classList.remove('active');
        }

        // --- UPDATED LIKE FUNCTIONALITY ---
        function toggleFromCard(e, id) { 
            e.stopPropagation(); 
            toggleFavorite(id); 
        }

        function toggleFavoriteCurrent() { 
            if(currentTrackId) toggleFavorite(currentTrackId); 
        }

        function toggleFavorite(id) { 
            if (favorites.has(id)) { 
                favorites.delete(id); 
                showNotification('Removed from Library', 'trash'); 
            } else { 
                favorites.add(id); 
                showNotification('Added to Liked Songs', 'heart'); 
            } 
            
            // Update all instances of this song across the UI
            updateGlobalLikeState(id);

            // If in library view, refresh
            if (currentSection === 'library') { 
                const tracks = masterList.filter(t => favorites.has(t.trackId)); 
                contentSections.innerHTML = ''; 
                renderCategoryRow("Your Favorites", tracks); 
                document.getElementById('status-text').textContent = `${tracks.length} saved songs`; 
            }
        }

        // HELPER TO UPDATE ALL HEARTS FOR A SONG
        function updateGlobalLikeState(id) {
            // 1. Update Footer Heart if playing
            if (currentTrackId === id) updateHeartIcon();

            // 2. Update all card buttons for this song
            // We use querySelectorAll to find every button with the specific ID class we added
            const buttons = document.querySelectorAll(`.like-btn-${id}`);
            buttons.forEach(btn => {
                if (favorites.has(id)) {
                    btn.classList.add('liked');
                } else {
                    btn.classList.remove('liked');
                }
            });
        }

        function updateHeartIcon() { 
            const b = document.getElementById('fav-btn'); 
            if(favorites.has(currentTrackId)) {
                // Updated to use the Spotify Green color
                b.innerHTML = '<i data-lucide="heart" class="w-4 h-4 fill-[#1ed760] text-[#1ed760]"></i>'; 
            } else {
                b.innerHTML = '<i data-lucide="heart" class="w-4 h-4"></i>'; 
            }
            lucide.createIcons(); 
        }
        
        function addToQueueFromCard(e, trackId) { e.stopPropagation(); const track = masterList.find(t => t.trackId === trackId); if (track) { playQueue.push(track); renderQueue(); updatePreviewMode(); showNotification('Added to Queue', 'list'); } }
        function removeFromQueue(i) { playQueue.splice(i, 1); renderQueue(); updatePreviewMode(); }
        function openSettings() { document.getElementById('settings-modal').classList.add('active'); }
        function closeSettings() { document.getElementById('settings-modal').classList.remove('active'); }
        function openCreatePlaylistModal() { document.getElementById('playlist-modal').classList.remove('active'); document.getElementById('create-playlist-modal').classList.add('active'); document.getElementById('new-playlist-input').focus(); }
        function closeCreatePlaylistModal() { document.getElementById('create-playlist-modal').classList.remove('active'); }
        function confirmCreatePlaylist() {
            const nameInput = document.getElementById('new-playlist-input'); const name = nameInput.value.trim();
            if (name) { userPlaylists.push({ id: Date.now(), name: name, tracks: new Set() }); renderSidebarPlaylists(); nameInput.value = ''; closeCreatePlaylistModal(); showNotification(`Playlist "${name}" created`, 'check'); }
        }
        function renderSidebarPlaylists() {
            document.getElementById('sidebar-playlists').innerHTML = userPlaylists.map(pl => `
                <div class="group flex items-center justify-between py-1 px-2 rounded-lg hover:bg-[#1a1a1a] cursor-pointer transition-colors">
                    <div class="flex items-center gap-3 flex-1 overflow-hidden" onclick="loadUserPlaylist(${pl.id})"><i data-lucide="list-music" class="w-4 h-4 text-gray-400"></i><span class="text-sm font-medium text-gray-400 group-hover:text-white truncate">${pl.name}</span></div>
                    <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="editPlaylist(${pl.id})" class="text-gray-500 hover:text-white"><i data-lucide="pencil" class="w-3 h-3"></i></button><button onclick="deletePlaylist(${pl.id})" class="text-gray-500 hover:text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button></div>
                </div>
            `).join(''); lucide.createIcons();
        }
        function loadUserPlaylist(id) {
            const pl = userPlaylists.find(p => p.id === id); if (!pl) return; currentSection = 'playlist'; document.getElementById('page-title').textContent = pl.name;
            const tracks = masterList.filter(t => pl.tracks.has(t.trackId)); 
            contentSections.innerHTML = '';
            renderCategoryRow(pl.name, tracks);
            document.getElementById('status-text').textContent = `${tracks.length} songs`;
        }
        function editPlaylist(id) { const pl = userPlaylists.find(p => p.id === id); const newName = prompt("Rename playlist:", pl.name); if (newName) { pl.name = newName; renderSidebarPlaylists(); if(currentSection === 'playlist') loadUserPlaylist(id); showNotification('Playlist renamed', 'pencil'); } }
        function deletePlaylist(id) { if(confirm("Delete this playlist?")) { userPlaylists = userPlaylists.filter(p => p.id !== id); renderSidebarPlaylists(); if(currentSection === 'playlist') navAction('home'); showNotification('Playlist deleted', 'trash-2'); } }
        function openPlaylistModal(e, trackId) { e.stopPropagation(); trackToAdd = trackId; renderPlaylistOptions(); document.getElementById('playlist-modal').classList.add('active'); }
        function closePlaylistModal() { document.getElementById('playlist-modal').classList.remove('active'); trackToAdd = null; }
        function renderPlaylistOptions() {
            const container = document.getElementById('playlist-options'); if (userPlaylists.length === 0) { container.innerHTML = '<p class="text-gray-500 text-sm py-4 text-center">No playlists created yet.</p>'; return; }
            container.innerHTML = userPlaylists.map(pl => `<div class="playlist-option" onclick="addToPlaylist(${pl.id})"><div class="flex items-center gap-3"><div class="w-8 h-8 bg-[#222] rounded flex items-center justify-center"><i data-lucide="music" class="w-4 h-4 text-gray-400"></i></div><span class="text-white font-medium">${pl.name}</span></div><span class="text-xs text-gray-500">${pl.tracks.size} songs</span></div>`).join(''); lucide.createIcons();
        }
        function addToPlaylist(playlistId) { const pl = userPlaylists.find(p => p.id === playlistId); if (pl && trackToAdd) { pl.tracks.add(trackToAdd); showNotification(`Added to ${pl.name}`, 'plus'); closePlaylistModal(); } }
        
        // --- MOVED HEART TOGGLE LOGIC TO TOP FOR CLARITY ---

        function navAction(action, btnEl) { 
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-nav')); 
            if (!btnEl) {
                if(action === 'home') btnEl = document.getElementById('nav-home');
                else if(action === 'search') btnEl = document.getElementById('nav-search');
                else if(action === 'library') btnEl = document.getElementById('nav-library');
            }
            if(btnEl) btnEl.classList.add('active-nav'); 
            document.querySelectorAll('.curated-item').forEach(b => b.classList.remove('active-curated')); 
            const searchView = document.getElementById('search-view');
            const contentSec = document.getElementById('content-sections');
            if (action === 'home') { 
                currentSection = 'discover'; 
                document.getElementById('page-title').textContent = 'Discover'; 
                searchView.classList.add('hidden');
                contentSec.classList.remove('hidden');
                fetchTracks(null); 
            } else if (action === 'search') { 
                currentSection = 'search';
                document.getElementById('page-title').textContent = 'Search';
                document.getElementById('status-text').textContent = 'Browse all categories';
                document.getElementById('search-input').value = ''; 
                contentSec.classList.add('hidden');
                searchView.classList.remove('hidden'); 
                document.getElementById('search-input').focus(); 
            } else if (action === 'library') { 
                currentSection = 'library'; 
                document.getElementById('page-title').textContent = 'Liked Songs'; 
                searchView.classList.add('hidden');
                contentSec.classList.remove('hidden');
                contentSec.innerHTML = ''; 
                const tracks = masterList.filter(t => favorites.has(t.trackId)); 
                renderCategoryRow("Your Favorites", tracks); 
                document.getElementById('status-text').textContent = `${tracks.length} saved songs`; 
            } 
        }

        function loadCurated(query, title) { 
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-nav')); 
            document.querySelectorAll('.curated-item').forEach(b => b.classList.remove('active-curated')); 
            const cards = document.querySelectorAll('.curated-card');
            if(title.includes('Bollywood')) cards[0]?.classList.add('active-curated');
            if(title.includes('Global')) cards[1]?.classList.add('active-curated');
            if(title.includes('Lo-Fi')) cards[2]?.classList.add('active-curated');

            currentSection = 'discover'; 
            fetchTracks(query, title); 
        }

        function updatePreviewMode() {
            const prev = document.getElementById('preview-container');
            if(playQueue.length > 0) prev.classList.add('shrunk');
            else prev.classList.remove('shrunk');
        }

        function buildQueue(startTrackId) { 
            const startIndex = currentGrid.findIndex(t => t.trackId === startTrackId); 
            if (startIndex !== -1) { 
                playQueue = currentGrid.slice(startIndex + 1); 
                if(isShuffle) {
                    for (let i = playQueue.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [playQueue[i], playQueue[j]] = [playQueue[j], playQueue[i]];
                    }
                }
                renderQueue(); 
                updatePreviewMode();
            } 
        }
        function renderQueue() {
            const qList = document.getElementById('queue-list'); document.getElementById('queue-count').textContent = `${playQueue.length} tracks`;
            if (playQueue.length === 0) { qList.innerHTML = '<div class="text-gray-500 text-sm italic text-center py-4">No upcoming tracks</div>'; return; }
            qList.innerHTML = playQueue.map((t, i) => `
                <div class="flex items-center gap-3 p-2 rounded hover:bg-white/5 cursor-pointer group">
                    <div onclick="playQueueTrack(${i})" class="flex items-center gap-3 flex-1 overflow-hidden"><img src="${t.artworkUrl60}" class="w-10 h-10 rounded object-cover opacity-70 group-hover:opacity-100"><div class="flex-1 overflow-hidden"><div class="text-white text-sm font-medium truncate">${t.trackName}</div><div class="text-gray-500 text-xs truncate">${t.artistName}</div></div><i data-lucide="play" class="w-3 h-3 text-white opacity-0 group-hover:opacity-100"></i></div>
                    <button onclick="removeFromQueue(${i})" class="text-gray-500 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                </div>
            `).join(''); lucide.createIcons();
        }
        function playQueueTrack(queueIdx) { const track = playQueue[queueIdx]; playQueue = playQueue.slice(queueIdx + 1); playTrack(track.trackId, false); updatePreviewMode(); }
        function playNext() { 
            if (repeatMode === 2) { audio.currentTime = 0; audio.play(); return; }
            if (playQueue.length > 0) { const track = playQueue[0]; playQueue.shift(); playTrack(track.trackId, false); updatePreviewMode(); } else { 
                if (isShuffle && currentGrid.length > 0) {
                    let randIndex; do { randIndex = Math.floor(Math.random() * currentGrid.length); } while (currentGrid.length > 1 && currentGrid[randIndex].trackId === currentTrackId);
                    playTrack(currentGrid[randIndex].trackId, false);
                } else {
                    const currentIndex = currentGrid.findIndex(t => t.trackId === currentTrackId);
                    if (currentIndex !== -1 && currentIndex < currentGrid.length - 1) { playTrack(currentGrid[currentIndex + 1].trackId, false); } else if (repeatMode === 1 && currentGrid.length > 0) { playTrack(currentGrid[0].trackId, false); }
                }
            } 
        }
        function playPrev() { audio.currentTime = 0; }
        function switchRightTab(tab) {
            const qContent = document.getElementById('queue-content'); const lContent = document.getElementById('lyrics-container'); const tQueue = document.getElementById('tab-queue'); const tLyrics = document.getElementById('tab-lyrics');
            if (tab === 'queue') { qContent.classList.add('active'); lContent.classList.remove('active'); tQueue.classList.add('active'); tLyrics.classList.remove('active'); } else { qContent.classList.remove('active'); lContent.classList.add('active'); tQueue.classList.remove('active'); tLyrics.classList.add('active'); generateLyrics(); }
        }
        function generateLyrics() {
            const container = document.getElementById('lyrics-text'); container.style.color = 'white';
            document.getElementById('analysis-result').classList.add('hidden');
            document.getElementById('analysis-result').innerHTML = '';
            const lines = ["Neon lights in the midnight rain", "Chasing shadows down memory lane", "The beat drops hard, the world stands still", "Climbing up this electric hill", "Vibe is real, vibe is deep", "Secrets that the rhythm keep", "(Instrumental Break)", "Can you feel it in the air?", "Music takes us anywhere."];
            container.innerHTML = lines.map(l => `<p class="lyrics-line">${l}</p>`).join('');
        }

        function playTrack(id, shouldBuildQueue = true) {
            document.getElementById('preview-container').classList.remove('video-mode');
            document.getElementById('video-player-container').classList.remove('active'); 
            document.getElementById('video-player-container').innerHTML = ''; 
            document.getElementById('side-art').style.display = 'block';
            const track = masterList.find(t => t.trackId === id); if(!track) return; currentTrackId = id;
            const img = track.artworkUrl100.replace('100x100', '600x600');
            document.getElementById('footer-title').textContent = track.trackName; document.getElementById('footer-artist').textContent = track.artistName; document.getElementById('footer-art').src = img;
            document.getElementById('side-title').textContent = track.trackName; document.getElementById('side-artist').textContent = track.artistName; document.getElementById('side-art').src = img;
            updateHeartIcon(); if(shouldBuildQueue) buildQueue(id); else renderQueue();
            audio.src = track.previewUrl; audio.play(); setPlayIcon(true); openRightPanel(); seekSlider.value = 0; updateSliderBackground(seekSlider);
            if(document.getElementById('tab-lyrics').classList.contains('active')) generateLyrics();
            const bg = document.getElementById('art-bg'); bg.style.backgroundImage = `url('${img}')`; bg.classList.add('active');
        }

        function togglePlay() { if (!audio.src) return; if (audio.paused) { audio.play(); setPlayIcon(true); } else { audio.pause(); setPlayIcon(false); } }
        function setPlayIcon(isPlaying) { document.getElementById('play-icon').innerHTML = isPlaying ? '<i data-lucide="pause" class="w-4 h-4 fill-black text-black"></i>' : '<i data-lucide="play" class="w-4 h-4 fill-black text-black ml-0.5"></i>'; const viz = document.getElementById('mini-viz'); if (isPlaying) viz.classList.remove('paused'); else viz.classList.add('paused'); lucide.createIcons(); }
        audio.addEventListener('ended', playNext);
        function updateSliderBackground(slider) { const min = parseFloat(slider.min)||0; const max = parseFloat(slider.max)||100; const val = parseFloat(slider.value)||0; const percentage = ((val-min)/(max-min))*100; slider.style.background = `linear-gradient(to right, #ffffff ${percentage}%, rgba(255,255,255,0.2) ${percentage}%)`; }
        volSlider.addEventListener('input', (e) => { audio.volume = e.target.value/100; updateSliderBackground(e.target); });
        function updateSeekUI() { if (!isDraggingSeek && !audio.paused && audio.duration) { const pct = (audio.currentTime/audio.duration)*1000; seekSlider.value = pct; updateSliderBackground(seekSlider); document.getElementById('curr-time').textContent = fmtTime(audio.currentTime); document.getElementById('total-time').textContent = fmtTime(audio.duration); } requestAnimationFrame(updateSeekUI); } updateSeekUI();
        seekSlider.addEventListener('mousedown', () => isDraggingSeek = true); seekSlider.addEventListener('touchstart', () => isDraggingSeek = true); seekSlider.addEventListener('input', (e) => { updateSliderBackground(e.target); if(audio.duration) document.getElementById('curr-time').textContent = fmtTime((e.target.value/1000)*audio.duration); }); seekSlider.addEventListener('change', (e) => { isDraggingSeek = false; if(audio.duration) audio.currentTime = (e.target.value/1000)*audio.duration; });
        function fmtTime(s) { const m = Math.floor(s/60); const sec = Math.floor(s%60); return `${m}:${sec<10?'0':''}${sec}`; }
        function showNotification(msg, icon) { const t = document.getElementById('toast'); document.getElementById('toast-msg').textContent = msg; t.classList.add('active'); setTimeout(() => t.classList.remove('active'), 2000); }
        const rightPanel = document.getElementById('right-panel'); function toggleRightPanel() { if(rightPanel.classList.contains('open')) closeRightPanel(); else openRightPanel(); } function openRightPanel() { rightPanel.classList.add('open'); document.getElementById('expand-btn').innerHTML = '<i data-lucide="minimize-2" class="w-4 h-4"></i>'; lucide.createIcons(); } function closeRightPanel() { rightPanel.classList.remove('open'); document.getElementById('expand-btn').innerHTML = '<i data-lucide="maximize-2" class="w-4 h-4"></i>'; lucide.createIcons(); }

        document.addEventListener('click', (e) => { const btn = e.target.closest('button, .mood-card, .profile-card, .song-card, .playlist-option, .group, .curated-card'); if (btn) { btn.classList.add('clicked-effect'); setTimeout(() => btn.classList.remove('clicked-effect'), 150); } });
        lucide.createIcons();
        startTypingAnimation();
        
        // Random seed for fresh discovery on load
        const randomSearchTerms = ["top hits 2024", "viral global hits", "trending music 2024", "chart topping hits", "popular songs", "summer vibes", "late night drive", "workout energy", "focus beats", "party anthems"];
    </script>
</body>
</html>